基于MeetHub后端项目的第一阶段成果（已完成数据模型、Schemas、DAO和基础API层），请继续开发JWT认证组件，重点实现**用户登录接口**及相关支撑工具。请按以下顺序分步骤开发，确保各组件职责清晰、易于集成和扩展。

---

### **一、开发目标概述**

* **总体目标** ：实现基于JWT的用户认证流程，包括令牌生成、验证、登录接口和请求拦截中间件。
* **已有基础** ：
* 用户模型（Users）和角色模型（Roles）
* 数据访问层（DAO）——提供用户查询接口
* Pydantic模式层（Schemas）——定义请求/响应结构
* **新开发组件** ：

1. JWT令牌生成工具
2. JWT令牌验证工具
3. 用户登录接口（路由）
4. JWT认证中间件（保护路由）

---

### **二、分阶段开发步骤**

#### **阶段1：开发JWT令牌生成与验证工具**

 **目录建议** ：在项目根目录下创建 `core/auth/` 目录，存放JWT相关工具。
 **命名规范** ：使用驼峰命名法（如：`JwtHandler`）。

##### **1.1 JWT令牌生成工具（`jwt_handler.py`）**

* **引入依赖库** ：
  **python**

  复制

  下载

```
  from jose import JWTError, jwt
  from datetime import datetime, timedelta
  from typing import Optional
```

* **编写逻辑** ：
* 定义密钥（SECRET_KEY）和算法（ALGORITHM），例如：
  **python**

  复制

  下载

  ```
  SECRET_KEY = "your-secret-key"  # 建议从环境变量读取
  ALGORITHM = "HS256"
  ACCESS_TOKEN_EXPIRE_MINUTES = 30
  ```
* 编写函数 `createAccessToken(data: dict, expiresDelta: Optional[timedelta] = None) -> str`：

  * 输入：用户数据（如用户ID）、可选过期时间
  * 逻辑：生成JWT令牌，包含过期时间（exp）、签发时间（iat）、主题（sub）
  * 返回：编码后的JWT字符串

##### **1.2 JWT令牌验证工具（同一文件或单独）**

* **编写函数** `verifyToken(token: str) -> dict`：
  * 输入：JWT令牌字符串
  * 逻辑：解码并验证令牌有效性（签名、过期时间）
  * 异常处理：捕获 `JWTError`，返回错误信息
  * 返回：解码后的负载（payload）或抛出异常

---

#### **阶段2：开发用户登录接口**

 **目录建议** ：在 `apps/` 目录下创建 `auth.py` 或扩展现有路由文件。
 **命名规范** ：路由函数使用驼峰命名（如：`handleLogin`）。

##### **2.1 定义登录请求/响应模式（Schemas）**

* 在 `schemas/` 目录下创建 `auth_schemas.py`：
  * `LoginRequest`：包含 `username` 和 `password` 字段
  * `LoginResponse`：包含 `accessToken`、`tokenType`（默认"bearer"）

##### **2.2 实现登录路由逻辑**

* **引入依赖** ：
* 使用现有 `UsersDAO` 查询用户
* 调用 `jwt_handler.createAccessToken` 生成令牌
* **编写路由** ：
* 路径：`/auth/login`
* 方法：POST
* 逻辑：
  1. 验证用户凭据（比对密码哈希）
  2. 若验证成功，生成JWT令牌（主题建议用用户ID）
  3. 返回 `LoginResponse` 结构
  4. 若失败，返回401错误

---

#### **阶段3：开发JWT认证中间件**

 **目录建议** ：在 `core/middleware/` 下创建 `auth_middleware.py`。
 **命名规范** ：类名使用驼峰（如：`JwtAuthMiddleware`）。

##### **3.1 编写中间件逻辑**

* **引入依赖** ：
* 使用 `jwt_handler.verifyToken` 验证令牌
* 依赖 `UsersDAO` 根据用户ID查询用户信息
* **中间件功能** ：
* 检查请求头中的 `Authorization` 字段（Bearer令牌）
* 验证令牌有效性
* 若有效，将用户对象注入请求状态（如 `request.state.user`）
* 若无效，返回401或403错误
* **集成到FastAPI** ：
* 使用 `app.middleware("http")` 装饰器注册中间件
* 可选：支持排除公开路由（如登录接口）

---

### **三、代码结构示例（简要）**

**text**

复制

下载

```
project/
├── core/
│   ├── auth/
│   │   └── jwt_handler.py         # JWT生成/验证工具
│   └── middleware/
│       └── auth_middleware.py     # JWT认证中间件
├── schemas/
│   ├── user_schemas.py            # 现有用户模式
│   └── auth_schemas.py            # 新登录请求/响应模式
├── dao/
│   └── users_dao.py               # 现有用户DAO
└── apps/
    ├── user_app.py                # 现有用户路由
    └── auth.py                    # 新登录路由
```

---

### **四、注意事项**

1. **安全建议** ：

* 密钥（SECRET_KEY）应从环境变量读取，不要硬编码
* 密码比较使用安全哈希（如bcrypt），确保与存储哈希一致

1. **错误处理** ：

* 登录失败返回清晰错误信息（如“用户名或密码错误”）
* JWT验证失败返回标准HTTP状态码（401/403）

1. **可扩展性** ：

* 中间件设计应支持角色权限验证（后续扩展）
* 令牌负载可包含用户角色信息，便于授权

---

请按以上步骤逐步实现，确保每个组件经过测试后再集成。最终目标是通过登录接口获取JWT令牌，并在后续请求中通过中间件验证令牌有效性。
