# 用户操作日志集成指南

## 一、在现有接口中集成日志记录

### 1. 在活动详情接口中记录浏览日志

在 `routers/activities.py` 中的 `get_activity_details` 接口：

```python
from dao.user_logs_dao import UserOperationLogsDAO
from schemas.user_logs import UserOperationLogCreate

user_logs_dao = UserOperationLogsDAO()

@router.get("/{activity_id}", response_model=Dict, status_code=status.HTTP_200_OK)
async def get_activity_details(activity_id: int, request: Request):
    """
    获取活动详情
    - 任何已登录用户可访问
    - 返回活动详细信息和统计数据
    - 记录用户浏览日志
    """
    try:
        # 获取活动详情
        activity = await activity_dao.get_activity_with_stats(activity_id)
        if not activity:
            raise HTTPException(
                status_code=status.HTTP_404_NOT_FOUND,
                detail="活动不存在"
            )

        # 增加浏览量
        activity.views_count += 1
        await activity.save()

        # ===== 新增：记录用户操作日志 =====
        user_id = request.state.user.id
        log_data = UserOperationLogCreate(
            activity_id=activity_id,
            operation_type="view_activity",
            extra_data={"source": "detail_view"}
        )
        await user_logs_dao.create_from_schema(user_id, log_data)
        # ===== 日志记录结束 =====

        return {
            "success": True,
            "data": activity,
            "message": "获取活动详情成功"
        }
    except HTTPException as he:
        raise he
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"获取活动详情失败: {str(e)}"
        )
```

### 2. 在报名接口中记录报名日志

在 `routers/registrations.py` 中的 `create_registration` 接口：

```python
from dao.user_logs_dao import UserOperationLogsDAO
from schemas.user_logs import UserOperationLogCreate

user_logs_dao = UserOperationLogsDAO()

@router.post("/", response_model=RegistrationInDB, status_code=http_status.HTTP_201_CREATED)
async def create_registration(registration: RegistrationCreate, request: Request):
    """
    创建活动报名
    - 需要登录用户
    - 验证活动状态和报名条件
    - 创建报名记录
    - 记录用户操作日志
    """
    try:
        # 获取当前用户信息
        participant_id = request.state.user.id

        # 检查活动是否存在且可报名
        activity = await activity_dao.get_activity_with_stats(registration.activity_id)
        if not activity:
            raise HTTPException(
                status_code=http_status.HTTP_404_NOT_FOUND,
                detail="活动不存在"
            )

        if activity.status != "published":
            raise HTTPException(
                status_code=http_status.HTTP_400_BAD_REQUEST,
                detail="活动当前状态不可报名"
            )

        if activity.current_participants >= activity.max_participants:
            raise HTTPException(
                status_code=http_status.HTTP_400_BAD_REQUEST,
                detail="活动报名人数已满"
            )

        # 创建报名记录
        registration_data = registration.model_dump(exclude={"activity_id"})
        created_registration = await registration_dao.create_registration(
            activity_id=registration.activity_id,
            participant_id=participant_id,
            data=registration_data
        )

        # ===== 新增：记录用户操作日志 =====
        log_data = UserOperationLogCreate(
            activity_id=registration.activity_id,
            operation_type="register_activity",
            extra_data={"status": created_registration.status}
        )
        await user_logs_dao.create_from_schema(participant_id, log_data)
        # ===== 日志记录结束 =====

        return created_registration

    except HTTPException as he:
        raise he
    except Exception as e:
        raise HTTPException(
            status_code=http_status.HTTP_400_BAD_REQUEST,
            detail=f"创建报名失败: {str(e)}"
        )
```

## 二、创建日志查询路由

创建 `routers/user_logs.py`：

```python
from fastapi import APIRouter, Depends, HTTPException, Request, Query, status
from typing import Optional
from schemas.user_logs import (
    UserOperationLogList,
    UserOperationLogDetail,
    UserOperationLogStats
)
from dao.user_logs_dao import UserOperationLogsDAO
from core.middleware.auth_middleware import JWTAuthMiddleware
from datetime import datetime

router = APIRouter(
    prefix="/user-logs",
    tags=["用户操作日志"],
    dependencies=[Depends(JWTAuthMiddleware())]
)

user_logs_dao = UserOperationLogsDAO()


@router.get(
    "/my/stats",
    response_model=UserOperationLogStats,
    status_code=status.HTTP_200_OK
)
async def get_my_stats(request: Request):
    """
    获取当前用户的操作统计
    - 返回用户的浏览次数、报名次数、独特活动数等统计信息
    """
    try:
        user_id = request.state.user.id
        stats = await user_logs_dao.get_user_stats(user_id)
        return stats
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"获取用户统计失败: {str(e)}"
        )


@router.get(
    "/my/logs",
    response_model=UserOperationLogList,
    status_code=status.HTTP_200_OK
)
async def get_my_logs(
    request: Request,
    operation_type: Optional[str] = Query(
        None,
        pattern="^(view_activity|register_activity)$"
    ),
    page: int = Query(1, gt=0),
    page_size: int = Query(10, gt=0, le=100)
):
    """
    获取当前用户的操作日志
    - 支持按操作类型筛选
    - 支持分页
    """
    try:
        user_id = request.state.user.id
        logs = await user_logs_dao.get_user_logs(
            user_id=user_id,
            operation_type=operation_type,
            page=page,
            page_size=page_size
        )
        return logs
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"获取用户日志失败: {str(e)}"
        )


@router.get(
    "/activity/{activity_id}/stats",
    response_model=dict,
    status_code=status.HTTP_200_OK
)
async def get_activity_operation_stats(
    activity_id: int,
    request: Request
):
    """
    获取活动的操作统计（浏览数、报名数等）
    - 返回活动的热度数据
    """
    try:
        stats = await user_logs_dao.get_activity_stats(activity_id)
        return {
            "success": True,
            "data": stats,
            "message": "获取活动统计成功"
        }
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"获取活动统计失败: {str(e)}"
        )


@router.get(
    "/my/viewed-activities",
    response_model=list,
    status_code=status.HTTP_200_OK
)
async def get_my_viewed_activities(
    request: Request,
    limit: int = Query(50, gt=0, le=200)
):
    """
    获取当前用户浏览过的活动ID列表
    - 用于推荐系统过滤已推荐活动
    """
    try:
        user_id = request.state.user.id
        activity_ids = await user_logs_dao.get_unique_viewed_activities(
            user_id=user_id,
            limit=limit
        )
        return {
            "success": True,
            "data": activity_ids,
            "count": len(activity_ids),
            "message": "获取浏览过的活动列表成功"
        }
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"获取浏览列表失败: {str(e)}"
        )


@router.get(
    "/my/registered-activities",
    response_model=list,
    status_code=status.HTTP_200_OK
)
async def get_my_registered_activities(
    request: Request,
    limit: int = Query(50, gt=0, le=200)
):
    """
    获取当前用户报名过的活动ID列表
    - 用于推荐系统过滤已推荐活动
    """
    try:
        user_id = request.state.user.id
        activity_ids = await user_logs_dao.get_unique_registered_activities(
            user_id=user_id,
            limit=limit
        )
        return {
            "success": True,
            "data": activity_ids,
            "count": len(activity_ids),
            "message": "获取报名过的活动列表成功"
        }
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"获取报名列表失败: {str(e)}"
        )
```

## 三、在主应用中注册路由

在 `main.py` 中添加：

```python
from routers import user_logs

# ... 其他路由注册

app.include_router(user_logs.router)
```

## 四、使用示例

### 4.1 记录用户浏览活动（异步，非阻塞）

```python
# 在后台异步记录日志，不影响主业务流程
asyncio.create_task(
    user_logs_dao.create_log(
        user_id=user_id,
        activity_id=activity_id,
        operation_type="view_activity",
        extra_data={"source": "search", "duration": 120}
    )
)
```

### 4.2 为推荐系统获取用户已操作的活动

```python
# 获取用户已浏览的活动
viewed_activities = await user_logs_dao.get_unique_viewed_activities(user_id)

# 获取用户已报名的活动
registered_activities = await user_logs_dao.get_unique_registered_activities(user_id)

# 推荐系统可以排除这些活动
recommended_activities = [
    a for a in all_activities
    if a.id not in viewed_activities and a.id not in registered_activities
]
```

### 4.3 获取活动的热度数据

```python
# 获取活动统计信息
stats = await user_logs_dao.get_activity_stats(activity_id)

# stats 包含：
# - total_views: 总浏览次数
# - total_registrations: 总报名次数
# - unique_viewers: 独特浏览用户数
# - unique_registrants: 独特报名用户数
```

### 4.4 检查用户是否已操作过该活动

```python
# 检查是否浏览过
has_viewed = await user_logs_dao.check_activity_viewed(user_id, activity_id)

# 检查是否报名过
has_registered = await user_logs_dao.check_activity_registered(user_id, activity_id)
```

## 五、性能优化建议

### 1. 异步记录日志（避免阻塞）

```python
import asyncio

# 在记录日志时使用后台任务
asyncio.create_task(
    user_logs_dao.create_from_schema(user_id, log_data)
)
```

### 2. 批量操作（当需要记录多条日志时）

```python
# 使用数据库的批量插入功能
await UserOperationLogs.bulk_create([
    UserOperationLogs(
        user_id=user_id,
        activity_id=activity_id,
        operation_type=operation_type,
        extra_data=extra_data
    ) for user_id, activity_id, operation_type, extra_data in data_list
])
```

### 3. 定期清理/归档旧日志（可选）

```python
# 删除30天前的日志
from datetime import datetime, timedelta

cutoff_time = datetime.now() - timedelta(days=30)
await UserOperationLogs.filter(created_at__lt=cutoff_time).delete()
```

## 六、常见集成场景

### 场景1：搜索活动后浏览

用户在搜索页面点击活动进入详情页时：
- 在 `search_activities` 返回列表时**不记录日志**
- 在 `get_activity_details` 中**记录浏览日志**

### 场景2：活动列表浏览

用户在主页滚动查看活动列表时：
- **可选择**在列表加载时记录（使用 extra_data 标记为 list_view）
- **或者**仅在点击进入详情时记录（标记为 detail_view）

### 场景3：报名后的推荐

报名成功后：
1. 创建 register_activity 日志
2. 推荐系统使用该日志过滤相似活动
3. 推荐系统也排除该用户已报名的其他活动

## 七、扩展方向

### 1. 添加更多操作类型

```python
# 在 operation_type 字段的 pattern 中扩展：
pattern="^(view_activity|register_activity|like_activity|share_activity|search_activity)$"
```

### 2. 收集更多 extra_data

```python
{
    "source": "search|list|recommendation",      # 来源
    "duration": 120,                              # 停留时长
    "device": "mobile|desktop",                   # 设备类型
    "os": "ios|android|windows|mac|linux",       # 操作系统
    "search_keywords": "篮球,校园活动",           # 搜索关键词
    "referrer": "/activities/search",             # 来源页面
    "position": 5,                                # 在列表中的位置
    "timestamp": 1699771200                       # Unix时间戳
}
```

### 3. 构建用户画像

基于日志数据构建用户兴趣向量，用于更精准的推荐。
