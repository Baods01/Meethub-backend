# 用户操作日志设计文档

## 一、设计概述

### 目标
为推荐算法提供用户行为数据，主要记录用户的两类核心操作：
- **浏览活动** (view_activity)：用户查看活动详情
- **报名活动** (register_activity)：用户报名参加活动

### 设计原则
1. **简洁性**：字段精简，便于推荐算法调用
2. **可扩展性**：通过 `extra_data` JSON字段支持未来扩展
3. **性能优化**：建立关键字段的索引，支持高效查询
4. **非侵入性**：不修改现有组件，通过中间件独立记录

---

## 二、数据库模型设计

### 表结构：`user_operation_logs`

| 字段名 | 类型 | 说明 | 特殊说明 |
|--------|------|------|---------|
| `id` | INT | 主键 | 自增 |
| `user_id` | INT | 用户ID | 外键关联Users表 |
| `activity_id` | INT | 活动ID | 外键关联Activities表 |
| `operation_type` | VARCHAR(50) | 操作类型 | 枚举：view_activity, register_activity |
| `created_at` | DATETIME | 操作时间 | 自动记录，包含索引 |
| `extra_data` | JSON | 附加数据 | 可选，用于扩展信息 |

### 索引设计
为优化查询性能，建立了三个复合索引：
```
1. (user_id, operation_type, created_at)    # 查询用户的特定操作
2. (activity_id, operation_type)             # 查询活动的操作统计
3. (user_id, created_at)                     # 查询用户操作历史
```

### 唯一性约束
- **无唯一约束**：允许同一用户多次浏览/报名同一活动，便于分析用户兴趣度变化

---

## 三、Schemas设计

### 1. 基础模式

#### `UserOperationLogBase`
所有操作日志共同包含的字段：
- `operation_type`：操作类型
- `extra_data`：附加数据

#### `UserOperationLogCreate`
创建操作日志时使用：
- `activity_id`：要关联的活动ID
- `operation_type`：操作类型
- `extra_data`：可选的附加信息

### 2. 响应模式

#### `UserOperationLogInDB`
从数据库查询返回的基础响应：
- 包含日志ID和创建时间
- 返回user_id和activity_id（用于关联查询）
- 轻量级，适合列表展示

#### `UserOperationLogDetail`
包含完整关联信息的详细响应：
- 内嵌 `UserBasicInfo`（用户信息）
- 内嵌 `ActivityInDB`（活动信息）
- 适合详情查看

### 3. 查询和统计模式

#### `UserOperationLogSearch`
支持多条件搜索参数：
```
- user_id：按用户筛选
- activity_id：按活动筛选
- operation_type：按操作类型筛选
- start_time/end_time：按时间范围筛选
- sort_by：排序方式（支持倒序）
- page/page_size：分页参数
```

#### `UserOperationLogStats`
用户操作统计：
- `total_views`：总浏览次数
- `total_registrations`：总报名次数
- `unique_viewed_activities`：浏览过的不同活动数
- `unique_registered_activities`：报名过的不同活动数
- `last_operation_time`：最后操作时间

---

## 四、使用建议

### 在中间件中的集成方式

#### 浏览活动记录
在 `/activities/{activity_id}` 接口中，获取活动详情时记录：
```python
# 记录浏览日志
log_data = UserOperationLogCreate(
    activity_id=activity_id,
    operation_type="view_activity",
    extra_data={"source": "detail_view"}  # 可选：记录来源
)
await user_logs_dao.create_log(user_id, log_data)
```

#### 报名活动记录
在 `/registrations` POST接口中，报名成功时记录：
```python
# 记录报名日志
log_data = UserOperationLogCreate(
    activity_id=registration.activity_id,
    operation_type="register_activity",
    extra_data={"status": "pending"}  # 可选：记录初始状态
)
await user_logs_dao.create_log(user_id, log_data)
```

### extra_data 字段用途示例

#### 浏览操作
```json
{
    "source": "detail_view",           // 来源：列表、搜索、推荐
    "duration": 120,                   // 浏览时长（秒）
    "device": "mobile",                // 设备类型
    "referrer": "/activities/search"   // 来源页面
}
```

#### 报名操作
```json
{
    "status": "pending",               // 报名初始状态
    "comment": "user's comment",       // 报名备注
    "source": "detail_view"            // 来源
}
```

---

## 五、推荐算法集成指南

### 查询用户的操作历史
```python
# 查询用户所有浏览过的活动（去重）
viewed_activities = await user_logs_dao.get_unique_activities(
    user_id=user_id,
    operation_type="view_activity",
    limit=50
)

# 查询用户近7天的活动操作
recent_logs = await user_logs_dao.search_logs(
    user_id=user_id,
    start_time=datetime.now() - timedelta(days=7),
    page=1,
    page_size=100
)
```

### 获取活动的热度数据
```python
# 查询活动被浏览/报名的次数
activity_stats = await user_logs_dao.get_activity_stats(activity_id)

# 获取活动的相似用户（都浏览过某些相同活动）
similar_users = await user_logs_dao.get_similar_users(
    user_id=user_id,
    limit=20
)
```

### 构建用户兴趣向量
基于操作日志的统计数据，推荐系统可以：
1. **过滤已推荐**：排除用户已浏览/报名的活动
2. **计算相似度**：基于共同浏览/报名的活动计算用户相似度
3. **热度排序**：优先推荐高热度（多人浏览/报名）活动
4. **时间衰减**：较早的操作权重递减，更关注近期兴趣

---

## 六、迁移和初始化

### 数据库迁移
确保在 `models/__init__.py` 中导入新模型：
```python
from .user_logs import UserOperationLogs
```

### DAO层示例
建议创建 `dao/user_logs_dao.py`：
```python
class UserOperationLogsDAO(BaseDAO):
    """用户操作日志数据访问层"""
    
    async def create_log(self, user_id: int, log_data: UserOperationLogCreate):
        """创建操作日志"""
        pass
    
    async def get_unique_activities(self, user_id: int, operation_type: str):
        """获取用户操作过的不同活动"""
        pass
    
    async def get_activity_stats(self, activity_id: int):
        """获取活动的操作统计"""
        pass
```

---

## 七、性能考虑

### 查询优化
- 使用分页查询，避免一次加载大量数据
- 对于推荐算法，建议缓存热点用户和热点活动的操作统计
- 定期归档或压缩旧日志（可选）

### 存储优化
- `extra_data` JSON字段压缩存储额外信息，避免表字段爆炸
- 定期清理或归档不需要的日志（基于业务规则）

### 并发处理
- 日志记录是异步操作，不阻塞主业务流程
- 推荐使用后台任务队列（如Celery）批量写入日志

---

## 八、后续扩展方向

可在 `extra_data` 中扩展的信息：
1. **用户设备信息**：IP地址、设备类型、浏览器
2. **交互时长**：用户停留时间、点击行为
3. **用户位置**：地理位置、校内位置
4. **推荐来源**：是否来自推荐系统、推荐算法版本
5. **转化标记**：浏览是否转化为报名、报名是否参加

这样设计既保持表结构简洁，又能灵活适应未来需求变化。
