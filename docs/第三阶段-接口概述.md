# Meethub后端 - 第三阶段接口概述

## 路由概览

本阶段主要开发了两个主要路由：

1. **管理员路由** (`/admin`)

   - 负责管理员对用户信息的管理
   - 需要管理员权限
   - 包含获取和修改用户信息的接口
2. **用户路由** (`/users`)

   - 负责用户对自己信息的管理
   - 需要用户登录
   - 包含更新个人信息的接口
3. **认证路由** (`/users`)

   - 注册、登录、令牌相关

## 接口详情

### 认证路由接口

#### 1. OAuth2密码模式登录

- **路径**：`POST /auth/login`
- **功能**：使用用户名密码进行登录认证
- **权限要求**：无需权限
- **调用说明**：
  - 需要提供username和password表单数据
  - 成功后返回JWT访问令牌
- **使用场景**：用户通过用户名和密码登录系统

#### 2. 多凭证登录

- **路径**：`POST /auth/login/credential`
- **功能**：支持使用用户名/邮箱/手机号进行登录
- **权限要求**：无需权限
- **调用说明**：
  - 可使用用户名、邮箱或手机号作为登录凭证
  - 需要提供password
  - 成功后返回JWT访问令牌
- **使用场景**：用户使用多种凭证方式登录系统

#### 3. 用户注册

- **路径**：`POST /auth/register`
- **功能**：新用户注册
- **权限要求**：无需权限
- **调用说明**：
  - 需提供用户名、密码、邮箱等必要信息
  - 自动分配普通用户角色
  - 返回创建的用户信息
- **使用场景**：新用户创建账号

#### 4. 获取当前用户信息

- **路径**：`GET /auth/me`
- **功能**：获取当前登录用户的详细信息
- **权限要求**：需要 `user:read`权限
- **调用说明**：
  - 需要在请求头中携带JWT令牌
  - 返回用户的完整信息，包括角色信息
- **使用场景**：获取已登录用户的个人信息

#### 5. 刷新访问令牌

- **路径**：`POST /auth/refresh`
- **功能**：刷新JWT访问令牌
- **权限要求**：需要有效的访问令牌
- **调用说明**：
  - 需要在请求头中携带当前JWT令牌
  - 返回新的访问令牌
- **使用场景**：令牌即将过期时刷新获取新令牌

#### 6. 重置密码验证

- **路径**：`POST /auth/reset-password/verify`
- **功能**：验证用户身份以重置密码
- **权限要求**：无需权限
- **调用说明**：
  - 需提供邮箱和手机号进行验证
  - 验证成功返回验证状态
- **使用场景**：用户忘记密码时的身份验证

#### 7. 重置密码

- **路径**：`POST /auth/reset-password`
- **功能**：重置用户密码
- **权限要求**：无需权限
- **调用说明**：
  - 需提供邮箱、手机号和新密码
  - 验证身份信息后更新密码
- **使用场景**：用户通过验证后重置新密码

### 管理员路由接口

#### 1. 获取所有用户ID列表

- **路径**：`GET /admin/users/ids`
- **功能**：获取系统中所有用户的ID和用户名信息
- **权限要求**：需要 `user:list`权限
- **调用说明**：
  - 需要在请求头中携带JWT令牌
  - 返回用户ID和用户名的列表
- **使用场景**：管理员查看系统中所有用户的基本信息

#### 2. 获取指定用户详细信息

- **路径**：`GET /admin/users/{user_id}`
- **功能**：获取指定ID用户的所有信息，包括基本信息和角色信息
- **权限要求**：需要 `user:read`权限
- **调用说明**：
  - 需要在请求头中携带JWT令牌
  - 在URL中指定用户ID
  - 返回用户的完整信息，包括角色详情
- **使用场景**：管理员查看特定用户的详细信息

#### 3. 更新指定用户信息

- **路径**：`PUT /admin/users/{user_id}`
- **功能**：修改指定用户的基本信息和角色信息
- **权限要求**：需要 `user:update`和 `user:roles`权限
- **调用说明**：
  - 需要在请求头中携带JWT令牌
  - 可以更新用户的所有基本信息
  - 可以同时更新用户的角色列表
  - 包含数据验证（用户名、邮箱、手机号唯一性）
- **使用场景**：管理员修改用户信息和角色分配

#### 4. 更新指定用户个性属性

- **路径**：`PATCH /admin/users/{user_id}/profile`
- **功能**：专门用于修改用户的个性属性(profile_attributes)字段
- **权限要求**：需要 `user:update`权限
- **调用说明**：
  - 需要在请求头中携带JWT令牌
  - 只更新个性属性字段
  - 支持完整替换个性属性内容
- **使用场景**：管理员修改用户的扩展信息

### 用户路由接口

#### 1. 更新当前用户信息

- **路径**：`PATCH /users/me`
- **功能**：允许用户更新自己的基本信息
- **权限要求**：需要用户登录（JWT认证）
- **可更新字段限制**：
  - nickname（昵称）
  - bio（个人简介）
  - profile_attributes（个性属性）
  - avatar（头像URL）
- **调用说明**：
  - 需要在请求头中携带JWT令牌
  - 只能更新允许的字段
  - 其他字段将被忽略
- **使用场景**：用户修改自己的个人信息

## 权限说明

1. **超级管理员**

   - 拥有所有接口的访问权限
   - 包含所有用户管理相关权限
2. **普通用户**

   - 只能访问用户路由下的接口
   - 只能修改自己的基本信息
   - 拥有 `user:read`权限

## 安全特性

1. **认证机制**

   - 所有接口都需要JWT令牌认证
   - 令牌通过Authorization请求头传递
   - 使用Bearer认证方案
2. **数据验证**

   - 用户名唯一性验证
   - 邮箱唯一性验证
   - 手机号唯一性验证
   - 字段格式和长度验证
3. **权限控制**

   - 基于角色的权限系统
   - 精确的权限控制
   - 权限验证中间件

## 注意事项

1. 所有接口都需要先通过登录接口获取JWT令牌
2. 管理员接口需要相应的权限，否则将返回403错误
3. 用户接口只能操作自己的信息，不能操作其他用户的信息
4. 数据更新操作都有相应的数据验证，确保数据一致性
