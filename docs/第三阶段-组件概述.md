# MeetHub 后端组件概述

本文档对 MeetHub 后端项目的各个组件进行详细说明，以帮助开发者更好地理解和使用这些组件。

## 1. 核心组件 (core/)

### 1.1 认证组件 (core/auth/)

#### JWT处理器 (jwt_handler.py)
- 提供 JWT 令牌的生成和验证功能
- 主要功能：
  - `create_access_token`: 创建访问令牌
  - `verify_token`: 验证令牌有效性
  - `create_token_response`: 生成标准令牌响应

### 1.2 中间件组件 (core/middleware/)

#### 认证中间件 (auth_middleware.py)
- 实现请求级别的 JWT 认证
- 功能：
  - 验证请求头中的 Bearer 令牌
  - 注入用户信息到请求状态
  - 处理公开路由白名单
  
### 1.3 权限组件

#### 权限定义 (permissions.py)
- 定义系统所有预设权限常量
- 包含权限分类：
  - 用户管理权限 (USER_*)
  - 角色管理权限 (ROLE_*)
  - 活动管理权限 (ACTIVITY_*)
  - 报名管理权限 (ENROLLMENT_*)
  - 系统管理权限 (SYSTEM_*)
  - AI助手权限 (AI_*)
- 预定义权限集合：
  - 超级管理员权限集 (SUPER_ADMIN_PERMISSIONS)
  - 活动组织者权限集 (ORGANIZER_PERMISSIONS)
  - 普通用户权限集 (USER_PERMISSIONS)

#### 权限检查器 (permission_checker.py)
- 提供权限验证相关功能
- 主要组件：
  - `PermissionChecker`: 权限验证器类
  - `requires_permissions`: 权限验证装饰器
- 功能：
  - 验证用户角色权限
  - 处理权限继承关系
  - 提供装饰器式的权限控制

## 2. 数据访问层 (dao/)

### 2.1 基础 DAO (base.py)
- 提供通用的数据访问操作
- 实现基础 CRUD 功能：
  - `create`: 创建记录
  - `get_by_id`: 通过 ID 获取记录
  - `get_all`: 获取所有记录
  - `update`: 更新记录
  - `delete`: 删除记录

### 2.2 用户 DAO (user_dao.py)
- 扩展基础 DAO，提供用户相关操作
- 主要功能：
  - 用户 CRUD 操作
  - 密码加密和验证
  - 用户角色管理
  - 用户查询（通过用户名、邮箱等）

### 2.3 角色 DAO (role_dao.py)
- 扩展基础 DAO，提供角色相关操作
- 主要功能：
  - 角色 CRUD 操作
  - 角色权限管理
  - 角色状态管理
  - 角色查询（通过名称、代码等）

## 3. 数据模型层 (models/)

### 3.1 用户模型 (users.py)
- 定义用户数据结构
- 主要字段：
  - 基本信息（用户名、邮箱、手机号等）
  - 安全相关（密码、验证状态）
  - 状态信息（激活状态、最后登录时间等）
  - 关联角色（多对多关系）

### 3.2 角色模型 (roles.py)
- 定义角色数据结构
- 主要字段：
  - 基本信息（名称、代码、描述）
  - 权限列表（JSON 格式存储）
  - 状态信息（激活状态、时间戳）

## 4. 模式层 (schemas/)

### 4.1 用户模式 (users.py)
- 定义用户相关的请求/响应模式
- 包含：
  - `UserBase`: 用户基础模式
  - `UserCreate`: 创建用户请求模式
  - `UserUpdate`: 更新用户请求模式
  - `UserResponse`: 用户响应模式

### 4.2 角色模式 (roles.py)
- 定义角色相关的请求/响应模式
- 包含：
  - `RoleBase`: 角色基础模式
  - `RoleCreate`: 创建角色请求模式
  - `RoleUpdate`: 更新角色请求模式
  - `RoleResponse`: 角色响应模式

### 4.3 认证模式 (auth.py)
- 定义认证相关的请求/响应模式
- 包含：
  - `LoginRequest`: 登录请求模式
  - `Token`: 令牌响应模式
  - `TokenData`: 令牌数据模式

## 5. 应用接口层 (apps/)

### 5.1 认证接口 (auth.py)
- 提供认证相关的路由
- 主要接口：
  - `/auth/login`: 用户登录接口

### 5.2 权限测试接口 (app02.py)
- 提供权限验证测试路由
- 测试接口：
  - `/test/auth-check`: JWT认证测试
  - `/test/admin-check`: 管理员权限测试
  - `/test/organizer-check`: 组织者权限测试
  - `/test/user-check`: 普通用户权限测试

### 5.3 开发测试接口
- 用户测试接口 (user_dtest.py)
  - 提供用户管理的完整测试接口
  - 包括：创建、查询、更新、删除用户等操作
  
- 角色测试接口 (roles_dtest.py)
  - 提供角色管理的完整测试接口
  - 包括：创建、查询、更新、删除角色等操作

## 6. 配置管理

### 6.1 主应用配置 (main.py)
- FastAPI 应用程序入口
- 配置：
  - API 文档设置
  - 路由注册
  - 数据库连接配置
  - CORS 和中间件设置

### 6.2 数据库配置 (settings.py)
- Tortoise-ORM 配置
- 定义：
  - 数据库连接参数
  - 模型映射关系
  - 时区设置

## 7. 使用说明

### 7.1 开发新接口
1. 在 `models/` 中定义数据模型
2. 在 `schemas/` 中创建对应的请求/响应模式
3. 在 `dao/` 中实现数据访问逻辑
4. 在 `apps/` 中创建路由接口
5. 使用 `permission_checker.py` 添加权限控制

### 7.2 权限控制
1. 在 `permissions.py` 中定义新的权限常量
2. 使用 `requires_permissions` 装饰器保护路由
3. 通过 `role_dao.py` 管理角色权限
4. 使用 `user_dao.py` 分配用户角色

### 7.3 认证流程
1. 客户端通过 `/auth/login` 获取 JWT 令牌
2. 在请求头中携带令牌访问受保护资源
3. `auth_middleware.py` 自动验证令牌
4. `permission_checker.py` 检查权限要求

## 8. 开发建议

1. **权限定义**：
   - 遵循 "资源:操作" 的命名格式
   - 在 `permissions.py` 中集中管理权限常量
   - 适当使用预定义的权限集合

2. **数据访问**：
   - 优先使用 DAO 层进行数据操作
   - 利用基础 DAO 类减少重复代码
   - 在 DAO 中实现业务逻辑验证

3. **接口开发**：
   - 使用 Pydantic 模型验证请求数据
   - 实现统一的错误处理
   - 添加适当的权限控制
   - 编写完整的接口文档

4. **测试验证**：
   - 使用测试接口验证功能
   - 检查权限控制的有效性
   - 验证数据完整性约束